## i/o 设备

- 块设备：**以固定大小的块，扇区或群集读取和（可选）写入数据**
- 字符设备：以`字符`为单位发送或接收一个字符流，**打印机、网络设备、鼠标、以及大多数与磁盘不同的设备**

![1608472465349](C:\Users\wqkant\AppData\Roaming\Typora\typora-user-images\1608472465349.png)

## 设备控制器

控制一个或多个I/O设备，以实现I/O设备和计算机之间的数据交换。

设备控制器通过应用程序的接口通过中断与操作系统进行通信。设备控制器是硬件，而设备驱动程序是软件。

控制器的任务是把串行的位流转换为字节块，并进行必要的错误校正工作。字节块通常会在控制器内部的一个缓冲区按位进行组装，然后再对校验和进行校验并证明字节块没有错误后，再将它复制到内存中。

![img](https://bkimg.cdn.bcebos.com/pic/30adcbef76094b369e116deea3cc7cd98d109d35?x-bce-process=image/watermark,image_d2F0ZXIvYmFpa2U5Mg==,g_7,xp_5,yp_5)

## dma

进一步把CPU从数据传送过程当中解放出来，进一步实现外部设备，数据传输它的独立性。

可以直接通过DMA实现外部设备和主存之间的数据传输。

整个过程，大概为：

1. io设备向DMAC发起DMA传输请求
2. DMAC 接到请求后，向cpu发出请求，并且将其请求信号加到cpu的HOLD保持请求输入端上
3. cpu接到请求后对DMAC作出回应，将其响应信号加到DMAC的HLDA保持响应输出端上，**同时向DMAC预置主存首地址以及交换数据个数和读写命令，并且放弃对系统总线的控制权，此时，DMAC获得系统总线的控制权**
4. DMAC将接到的响应后，**将响应转交给io设备，开始数据的传输**。
5. 数据传输完毕后，DMAC将HOLD信号设置为无效并加到cpu上
6. cpu接到HOLD信号判定为无效，就知道数据传输完毕，同时把HLDA信号设置为无效加到DMAC上，并且重新获得系统总线的控制权

总之，在系统进行DMA数据交换的过程中，cpu都不得获得系统总线的控制权，在此过程当中，cpu只需开始和结束的对DMAC进行响应，其余的时间，cpu可以处理其他的事情，比如处理中断之前的作业。

iop的出现，通道结构又被称作输入输出处理机为iop，iop独立于cpu，是一个专门管理io的处理机。它把cpu从众多的io操作中释放出来，减少了cpu的负担，与此同时，系统的io操作都由iop来负责， 并且一个iop能够控制许多的设备进行io操作，还能实现iop的复用，无疑减少了中断次数，提高了cpu的效率。



## 存储设备

- 寄存器
- 高速缓冲区
- 内存
- 磁盘

## 中断

时钟中断只是一个周期性的信号，完全是硬件行为，该信号触发CPU去执行一个中断服务程序

时钟中断与进程调度密不可分，因此，一旦开始有时钟中断就可能要进行调度

当一个 **I/O 设备完成它的工作后，它就会产生一个中断**

中断向量表

中断优先级

## 缓冲区操作

特权等级： 

ring0:内核态

ring3:用户态

1. 无法执行`in`和`out`等IO指令，如果任何程序可以直接从磁盘读取，则文件权限将毫无用处。
2. 无法注册中断处理程序。
3. 无法修改页面表。



![img](file://C:/Users/wqkant/AppData/Roaming/Typora/typora-user-images/1607238122789.png?lastModify=1608469306)

## 虚拟内存

这样做好处颇多，总结起来可分为两大类：

1. 一个以上的虚拟地址可指向同一个物理内存地址。
2. 虚拟内存空间可大于实际可用的硬件内存。
   • 面向文件的 I/O 和流 I/O
   • 多工 I/O（就绪性选择）
3. **把内核空间地址与用户空间的虚拟地址映射到同一个物理地址**，这样，**DMA 硬件（只能访问物理内存地址）就可以填充对内核与用户空间进程同时可见的缓冲区**，但前提条件是，**内核与用户缓冲区必须使用相同的页对齐，缓冲区的大小还必须是磁盘控制器块大小（通常为 512 字节磁盘扇区）的倍数**。操作系统把内存地址空间划分为页，即固定大小的字节组。

![1607239184472](C:\Users\wqkant\AppData\Roaming\Typora\typora-user-images\1607239184472.png)

## 分页技术

![1607239443077](C:\Users\wqkant\AppData\Roaming\Typora\typora-user-images\1607239443077.png)

**把内存页大小设定为磁盘块大小的倍数，这样内核就可直接向磁盘控制硬件发布命令，把内存页写入磁盘，在需要时再重新装入**。结果是，**所有磁盘 I/O 都在页层面完成**。对于采用分页技术的现代操作系统而言，这也是**数据在磁盘与物理内存之间往来的唯一方式**。	内存管理单元（MMU），逻辑上位于 CPU 与物理内存之间。该设备包含虚拟地址向物理内存地址转换时所需映射信息。如果当前不存在与该虚拟页形成有效映射的物理内存页，MMU 会向 CPU 提交一个页错误。

​	**页错误随即产生一个陷阱（类似于系统调用），把控制权移交给内核**，附带导致错误的虚拟地址信息，然后内核采取步骤验证页的有效性。内核会安排页面调入操作，把缺失的页内容读回物理内存。这往往导致别的页被移出物理内存，好给新来的页让地方。在这种情况下，如果待移出的页已经被碰过了（自创建或上次页面调入以来，内容已发生改变），还必须首先执行页面调出，把页内容拷贝到磁盘上的分页区。

## 文件I/O

​	**文件 I/O 属文件系统范畴，文件系统与磁盘迥然不同**。磁盘把数据存在扇区上，通常一个扇区512 字节。磁盘属硬件设备，对何谓文件一无所知，它只是提供了一系列数据存取窗口。在这点上，**磁盘扇区与内存页颇有相似之处：都是统一大小，都可作为大的数组被访问。**

​	**文件系统是更高层次的抽象，是安排、解释磁盘（或其他随机存取块设备）数据的一种独特方式**。您所写代码几乎无一例外地要与文件系统打交道，而不是直接与磁盘打交道。是文件系统定义了文件名、路径、文件、文件属性等抽象概念。

## 内存映射文件

![1607240309508](C:\Users\wqkant\AppData\Roaming\Typora\typora-user-images\1607240309508.png)

**在处理大量数据时，如果数据缓冲区是按页齐的，且大小是内建页大小的倍数，那么，对大多数操作系统而言，其处理效率会大幅提升。**

## 文件锁定

**锁定区域往往可以细致到单个字节**。文件锁定有两种方式：**共享的和独占的。**多个共享锁可同时对同一文件区域发生作用；独占锁则不同，它要求相关区域不能有其他锁定在起作用。

## i/o 软件的目的



- #### 不同设备，一样的接口：抽象

- #### 错误处理：透明化

- #### 同步和异步传输

同步传输中数据通常以块或帧的形式发送。发送方和接收方在数据传输之前应该具有`同步时钟`。而在异步传输中，数据通常以字节或者字符的形式发送，异步传输则不需要同步时钟，但是会在传输之前向数据添加`奇偶校验位`。

![1608473878937](C:\Users\wqkant\AppData\Roaming\Typora\typora-user-images\1608473878937.png)

## i/o子系统的层次结构



![img](https://img-blog.csdn.net/20180226173944625?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGllcm1pbmdfXw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)